# AzureMonitorStarterPacksCollector

## Instalation steps

Single command line for instalation:

Install command:
```bash
curl -SL https://raw.githubusercontent.com/Welasco/AzureMonitorStarterPacksCollector/main/install.sh | sudo -E bash -
```

The installation will create a folder at this path: /opt/azuremonitorstarterpackscollector.

It will download the executable file "AzureMonitorStarterPacksCollector" and the config file "config_collector.ini" in the same location.

After it will download the systemd service file "azuremonitorstarterpackscollector.service" under the default systemd path /lib/systemd/system.

In the end it will reload systemd daemons, enable the service azuremonitorstarterpackscollector and start it.

You can control the execution like any other systemd service using the following commands:

Get status of the service azuremonitorstarterpackscollector:
```bash
systemd status azuremonitorstarterpackscollector
```

Stop the service azuremonitorstarterpackscollector
```bash
systemd stop azuremonitorstarterpackscollector
```

Start the service azuremonitorstarterpackscollector
```bash
systemd start azuremonitorstarterpackscollector
```
## Configuring the service azuremonitorstarterpackscollector
This service has a configuration file named config_collector.ini that must exist under the same folder as the main executable file "AzureMonitorStarterPacksCollector".

This configuration file has the following format and options:

```config
; All the configuration file is loaded using a Go gcfg library
; It automatically load the file and map it to a modeling file config.go. 
; This file must have a specific structure following the library reference to work.
; Reference: https://pkg.go.dev/gopkg.in/gcfg.v1
; This is the main section of the configuration file
; Settings under this section are used for the main process
[main]
logPath=/var/log/azuremonitorstarterpackscollector.log ; Log path for the service azuremonitorstarterpackscollector.
logLevel=Inf ; Log level options as --> Err, Warn, Inf, Deb

; This is the Collector specific section, in this case is nginxCollector
; Currently there is only one collector available
[nginxCollector]
logPath=/var/log/nginx/nginx_metrics.log ; This is the telemetry file in the CSV format been generated by the Nginx Collector

; This is a sub section of the nginxCollector in case in needed to be loaded multiple times to monitor different websites.
; The name "SiteName1" is the name of the site being monitored and the name nginxCollectorWebsite is the subsection.
[nginxCollectorWebsite "SiteName1"]
url=http://localhost/nginx_status
scrapeIntervalsec=5

[nginxCollectorWebsite "SiteName2"]
url=http://localhost/nginx_status
scrapeIntervalsec=15
```

Uninstall command:
```bash
curl -SL https://raw.githubusercontent.com/Welasco/AzureMonitorStarterPacksCollector/main/uninstall.sh | sudo -E bash -
```

## Setup NGINX

This setting must be applied to a available site in NGINX.

```bash
# Default server configuration
#
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }

        location /nginx_status {
                # Turn on stats
                stub_status on;
                # only allow access from 192.168.1.5 #
                #allow 192.168.1.5;
                #deny all;
        }

}
```
Reference: http://nginx.org/en/docs/http/ngx_http_stub_status_module.html

Looks like there is a new module to do the same written in a API style. Need further investigation.

Reference: https://nginx.org/en/docs/http/ngx_http_api_module.html

## Code reference

The idea of this project was to implement a log collector using Go lang.

This code are using an interface to allow more collectors to be implemented.

Currently there is only one collector been implemented which is Nginx Collector.

The NGINX Collector is calling the url http://localhost/nginx_status which give the status in the following format as a result of a Get HTTP request:

```
Active connections: 1 
server accepts handled requests
 73 73 444 
Reading: 0 Writing: 1 Waiting: 0
```

This format is parsed to a CSV file for latter consumption from AzureMonitorStarterPacks.

To build the code just follow this steps:

- Install Go
- Download the Repo
- Execute from the go directory the build command: go build
- The executable file AzureMonitorStarterPacksCollector will be created